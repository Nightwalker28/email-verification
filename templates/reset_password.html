<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            border-radius: 5px;
            min-width: 200px;
            display: none; /* Hide by default */
        }
    </style>
    <script>
        function displayMessage(message, isError = false) {
            const messageContainer = $('#message-container');
            messageContainer.removeClass('d-none alert-success alert-danger');
            messageContainer.addClass(isError ? 'alert-danger' : 'alert-success');
            messageContainer.text(message);
            messageContainer.show();
            
            if (!isError) {
                // Hide the message after 5 seconds if it's a success
                setTimeout(() => {
                    messageContainer.hide();
                    // Close the window after the message is hidden
                    window.close(); // Attempt to close the window
                }, 5000);  // 5000 milliseconds = 5 seconds
            } else {
                // For error messages, just keep it until the user closes it or submits again
                setTimeout(() => messageContainer.hide(), 5000);  // Hide message after 5 seconds for errors as well
            }
        }

        function validateForm(event) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            // Password validation pattern
            const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

            // Check if passwords match
            if (password !== confirmPassword) {
                event.preventDefault();
                displayMessage('Passwords do not match. Please try again.', true);
                return false; // Prevent form submission
            }

            // Check if password is strong
            if (!passwordPattern.test(password)) {
                event.preventDefault();
                displayMessage('Password must be at least 8 characters long and include at least one uppercase letter, one lowercase letter, one number, and one special character.', true);
                return false; // Prevent form submission
            }
            return true; // Form is valid
        }

        $(document).ready(function() {
    $('#resetForm').on('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const password = $('#password').val();
        const token = $('input[name="token"]').val(); // Get the token from the hidden input

        // Send the password and token to the backend
        $.ajax({
            url: `/reset/${token}`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ password: password }), // Send password as JSON
            success: function(response) {
                // Access the 'success' key instead of 'message'
                displayMessage(response.success, false);
            },
            error: function(xhr) {
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred";
                displayMessage(errorMessage, true);
            }
        });
    });
});
    </script>
</head>
<body>
    <div id="message-container" class="alert d-none"></div> <!-- Alert Message Container -->
    <div class="container">
        <h2>Reset Your Password</h2>
        <form id="resetForm" method="POST" onsubmit="validateForm(event)">
            <input type="hidden" name="token" value="{{ token }}">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required><br>
            
            <label for="confirm_password">Confirm Password:</label>
            <input type="password" id="confirm_password" name="confirm_password" required><br>
            
            <button type="submit">Reset Password</button>
        </form>
        
        <div>
            <a href="/">Back to login</a>
        </div>
    </div>
</body>
</html>
